name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$TAG_VERSION" >> "$GITHUB_OUTPUT"
          echo "Building version: $TAG_VERSION"

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint
        run: make lint

      - name: Build
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: make build VERSION="$VERSION"

      - name: Run all tests
        run: |
          echo "Running validation tests..."
          bash tests/validate-build.sh build/vibrate.sh

          echo "Running unit tests..."
          bash tests/test-docker-runtime.sh

          echo "Running integration tests..."
          bash tests/test-runtime-integration.sh

      - name: Verify version in artifact
        env:
          EXPECTED_VERSION: ${{ steps.version.outputs.version }}
        run: |
          BUILT_VERSION=$(build/vibrate.sh --version | head -1)
          echo "Built version: $BUILT_VERSION"
          if [[ ! "$BUILT_VERSION" =~ "vibrator version $EXPECTED_VERSION" ]]; then
            echo "Error: Version mismatch!"
            echo "Expected: vibrator version $EXPECTED_VERSION"
            echo "Got: $BUILT_VERSION"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd build
          sha256sum vibrate.sh > vibrate.sh.sha256
          cat vibrate.sh.sha256

      - name: Create release
        env:
          TAG_NAME: ${{ github.ref_name }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/vibrate.sh
            build/vibrate.sh.sha256
          generate_release_notes: true
          body: |
            ## Installation

            **Option A: Pre-built Docker image (fastest)**
            ```bash
            # Download vibrate.sh
            curl -fsSL https://github.com/wlame/vibrator/releases/download/${{ env.TAG_NAME }}/vibrate.sh -o vibrate.sh
            chmod +x vibrate.sh

            # Pull pre-built image (~2GB, skips 10+ min build)
            ./vibrate.sh --pull

            # Run
            ./vibrate.sh
            ```

            **Option B: Build locally**
            ```bash
            curl -fsSL https://github.com/wlame/vibrator/releases/download/${{ env.TAG_NAME }}/vibrate.sh -o vibrate.sh
            chmod +x vibrate.sh

            # Verify checksum (optional)
            curl -fsSL https://github.com/wlame/vibrator/releases/download/${{ env.TAG_NAME }}/vibrate.sh.sha256 -o vibrate.sh.sha256
            sha256sum -c vibrate.sh.sha256

            # First run builds the image automatically
            ./vibrate.sh
            ```

            ## Docker Image

            ```bash
            docker pull ghcr.io/wlame/vibrator:${{ env.TAG_NAME }}
            ```

            ## Quick Start

            ```bash
            # Interactive shell
            vibrate

            # Run Claude with a prompt
            vibrate claude "help me refactor this code"

            # See all options
            vibrate --help
            ```

            ## What's Changed

            See the release notes below for detailed changes.
