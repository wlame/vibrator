# Generated by vibrator
# Do not edit this file directly - modify templates/Dockerfile.template in source

# ============================================================================
# Stage 1: System packages and tools
# ============================================================================
FROM ubuntu:24.04 AS base

RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    wget \
    git \
    python3 \
    python3-pip \
    unzip \
    sudo \
    fzf \
    zsh \
    gh \
    vim \
    htop \
    jq \
    tree \
    ripgrep \
    fd-find \
    gpg \
 && rm -rf /var/lib/apt/lists/*

# Install Go from Ubuntu repos (needed by some MCP servers)
RUN apt-get update && \
    apt-get install -y golang-go && \
    rm -rf /var/lib/apt/lists/*

# Install agent-browser MCP server (headless web app debugging)
RUN ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then AGENT_ARCH="amd64"; else AGENT_ARCH="arm64"; fi && \
    curl -fsSL "https://github.com/kontext-dev/agent-browser/releases/download/v1.1.0/agent-browser-v1.1.0-linux-${AGENT_ARCH}.tar.gz" \
    -o agent-browser.tar.gz && \
    tar -xzf agent-browser.tar.gz && \
    mv agent-browser /usr/local/bin/ && \
    chmod +x /usr/local/bin/agent-browser && \
    rm agent-browser.tar.gz

# Create user with host UID/GID for proper file permissions on mounted volumes
ARG USERNAME=claude-user
ARG HOST_UID=1000
ARG HOST_GID=1000
RUN (getent group ${HOST_GID} || groupadd -g ${HOST_GID} ${USERNAME}) && \
    useradd -m -s /bin/zsh -u ${HOST_UID} -g ${HOST_GID} ${USERNAME} && \
    echo "${USERNAME} ALL=(root) NOPASSWD:ALL" > /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME}

# ============================================================================
# Stage 2: User environment (zsh, oh-my-zsh, uv)
# ============================================================================
FROM base AS user-env

USER $USERNAME
WORKDIR /home/$USERNAME

RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended && \
    git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions && \
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting

RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/home/$USERNAME/.local/bin:$PATH"

# ============================================================================
# Stage 3: Claude CLI and MCP servers
# ============================================================================
FROM user-env AS claude-mcp

RUN curl -fsSL https://claude.ai/install.sh | bash
ENV PATH=/home/$USERNAME/.local/bin:$PATH

RUN claude mcp add context7 \
    --scope user \
    --transport http \
    https://mcp.context7.com/mcp

RUN claude mcp add serena \
    --scope user \
    -- uvx --from git+https://github.com/oraios/serena serena start-mcp-server --project-from-cwd

RUN uvx superclaude install

@@PLUGIN_SECTION@@

# ============================================================================
# Stage 4: Final runtime
# ============================================================================
FROM claude-mcp AS runtime

USER root

# Install Langfuse SDK for observability hook
RUN pip3 install --break-system-packages langfuse

# Create container-specific Claude rules directory
RUN mkdir -p /opt/container-rules

# Decode and install container rules
RUN echo '@@CONTAINER_RULES_CONTEXT_B64@@' | base64 -d > /opt/container-rules/docker-container-context.md
RUN echo '@@CONTAINER_RULES_SAFETY_B64@@' | base64 -d > /opt/container-rules/safety-restrictions.md

RUN echo '@@ENTRYPOINT_B64@@' | base64 -d > /entrypoint.sh && chmod +x /entrypoint.sh
RUN echo '@@CLAUDE_EXEC_B64@@' | base64 -d > /usr/local/bin/claude-exec && chmod +x /usr/local/bin/claude-exec
RUN echo '@@LANGFUSE_HOOK_B64@@' | base64 -d > /opt/langfuse-hook.py && chmod +x /opt/langfuse-hook.py

USER $USERNAME
WORKDIR /home/$USERNAME

ENV COLORTERM=truecolor

RUN echo '@@ZSHRC_B64@@' | base64 -d > ~/.zshrc

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/zsh"]
