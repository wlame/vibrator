export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="example"
plugins=(git zsh-autosuggestions zsh-syntax-highlighting)
source $ZSH/oh-my-zsh.sh

# Prompt prefix
export PS1="%F{yellow}[%F{red}vb%F{yellow}]%f $PS1"

# History
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000

# Claude aliases - conditional on dangerous mode
if [ "$VIBRATOR_DANGEROUS" = "1" ]; then
  alias claude="claude --dangerously-skip-permissions"
fi
alias claude-safe="command claude"

# General aliases
alias ll="ls -la"

# Use neovim if available, otherwise fall back to vim
if command -v nvim >/dev/null 2>&1; then
  alias vim="nvim"
  alias vi="nvim"
fi

# Git SSH configuration
export GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o LogLevel=ERROR"

# Welcome message (interactive shells only)
if [[ -o interactive ]]; then
  echo -e "\033[1;36m+--------------------------------------------------------------+\033[0m"
  echo -e "\033[1;36m|\033[0m  \033[1;33mClaude Code Docker Environment\033[0m                              \033[1;36m|\033[0m"
  echo -e "\033[1;36m+--------------------------------------------------------------+\033[0m"
  echo ""
  echo -e "\033[1;32mClaude CLI:\033[0m $(claude --version 2>/dev/null | head -1 || echo 'Not installed')"

  # Authentication status
  if [ -n "$CLAUDE_CODE_OAUTH_TOKEN" ]; then
    echo -e "\033[1;32mAuthentication:\033[0m Authenticated by OAuth token"
  elif [ -n "$ANTHROPIC_API_KEY" ]; then
    echo -e "\033[1;32mAuthentication:\033[0m Authenticated by Anthropic API Key"
  else
    echo -e "\033[1;33mAuthentication:\033[0m Not authenticated"
  fi

  echo ""
  echo -e "\033[1;32mTools:\033[0m Go $(go version 2>/dev/null | awk '{print $3}' || echo 'N/A'), Python $(python3 --version 2>/dev/null | awk '{print $2}' || echo 'N/A'), Vim, Git, GitHub CLI"
  if pgrep -x agent-browser >/dev/null 2>&1; then
    echo -e "\033[1;32mMCP Servers:\033[0m Context7, Serena, Agent Browser"
    echo -e "\033[1;32mAgent Browser Web UI:\033[0m http://localhost:8080/ui/"
  else
    echo -e "\033[1;32mMCP Servers:\033[0m Context7, Serena"
  fi

  # Langfuse observability status
  if [ "$LANGFUSE_MODE" = "host" ]; then
    echo -e "\033[1;32mLangfuse:\033[0m Enabled (host hook)"
  elif [ "$LANGFUSE_MODE" = "auto" ]; then
    echo -e "\033[1;32mLangfuse:\033[0m Enabled (auto-detected)"
  else
    echo -e "\033[1;90mLangfuse:\033[0m Not configured"
  fi

  echo ""
  echo -e "\033[1;32mWorkspace:\033[0m $WORKSPACE_PATH"
  echo ""

  # Docker-in-Docker security warning
  if [ "$VIBRATOR_DOCKER_IN_DOCKER" = "1" ]; then
    echo -e "\033[1;33m+--------------------------------------------------------------+\033[0m"
    echo -e "\033[1;33m|  ⚠️  DOCKER-IN-DOCKER MODE ENABLED\033[0m                          \033[1;33m|\033[0m"
    echo -e "\033[1;33m+--------------------------------------------------------------+\033[0m"
    echo -e "\033[1;33m   This container runs with ELEVATED PRIVILEGES:\033[0m"
    echo -e "   • Docker socket mounted (/var/run/docker.sock)"
    echo -e "   • CAP_SYS_ADMIN capability granted"
    echo -e "   • Seccomp filtering disabled"
    echo ""
    echo -e "\033[1;33m   Security Impact:\033[0m"
    echo -e "   • Container escape is possible if compromised"
    echo -e "   • Full access to host Docker daemon"
    echo -e "   • Use only when Docker commands are needed"
    echo ""
    echo -e "\033[1;90m   Run without --dind/--docker for secure mode\033[0m"
    echo -e "\033[1;33m+--------------------------------------------------------------+\033[0m"
    echo ""
  fi

  echo -e "\033[1;90mType 'claude --help' to get started\033[0m"
  echo ""
fi
